name: ingress

on:
  workflow_dispatch:

env:
  KUBE_DIR: /home/deployer/kubernetes
  KUBE_NAMESPACE: app
  KUBE_ADMIN_CONFIG: /home/deployer/.kube/admin.config

jobs:
  deploy-ingress:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare remote kubernetes directory
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            KUBE_DIR=/home/deployer/kubernetes
            rm -rf "${KUBE_DIR}"
            install -d -m 0755 "${KUBE_DIR}"

      - name: Upload kubernetes manifests
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "."
          target: "/home/deployer/kubernetes"
          overwrite: true

      - name: Install ingress-nginx
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            KUBECTL=/usr/local/bin/kubectl
            KUBECONFIG=/home/deployer/.kube/admin.config
            ${KUBECTL} --kubeconfig ${KUBECONFIG} apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.10.1/deploy/static/provider/baremetal/deploy.yaml
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n ingress-nginx rollout status deploy/ingress-nginx-controller --timeout=180s
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n ingress-nginx patch svc ingress-nginx-controller -p '{"spec":{"type":"LoadBalancer"}}'
            for i in $(seq 1 60); do
              ip=$(${KUBECTL} --kubeconfig ${KUBECONFIG} -n ingress-nginx get svc ingress-nginx-controller -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || true)
              if [ -n "${ip}" ]; then
                break
              fi
              sleep 2
            done
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n ingress-nginx get svc ingress-nginx-controller -o wide

      - name: Install cert-manager
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            KUBECTL=/usr/local/bin/kubectl
            KUBECONFIG=/home/deployer/.kube/admin.config
            ${KUBECTL} --kubeconfig ${KUBECONFIG} apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.14.4/cert-manager.yaml
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n cert-manager rollout status deploy/cert-manager --timeout=180s
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n cert-manager rollout status deploy/cert-manager-webhook --timeout=180s
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n cert-manager rollout status deploy/cert-manager-cainjector --timeout=180s

      - name: Apply ingress manifests
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            KUBECTL=/usr/local/bin/kubectl
            KUBECONFIG=/home/deployer/.kube/admin.config
            KUBE_DIR=/home/deployer/kubernetes
            if [ -d "${KUBE_DIR}/kubernetes" ]; then
              KUBE_DIR="${KUBE_DIR}/kubernetes"
            fi
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n app delete ingress clash --ignore-not-found
            ${KUBECTL} --kubeconfig ${KUBECONFIG} apply -k ${KUBE_DIR}/core
            ${KUBECTL} --kubeconfig ${KUBECONFIG} apply -k ${KUBE_DIR}/ingress

      - name: Remove legacy caddy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            KUBECTL=/usr/local/bin/kubectl
            KUBECONFIG=/home/deployer/.kube/admin.config
            KUBE_NAMESPACE=app
            ${KUBECTL} --kubeconfig ${KUBECONFIG} -n ${KUBE_NAMESPACE} delete deploy/caddy svc/caddy configmap/caddy-config secret/caddy-e2e --ignore-not-found

      - name: Check clash ingress
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail
            code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://clash.liberte.top/api/v1/health)
            if [ "${code}" != "200" ]; then
              echo "unexpected status ${code}"
              exit 1
            fi
