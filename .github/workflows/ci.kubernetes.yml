name: kubernetes

on:
  workflow_dispatch:

jobs:
  apply-kubernetes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: latest

      - name: Connect Tailscale
        uses: tailscale/github-action@v4
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Write kubeconfig
        env:
          KUBECONFIG_B64: ${{ secrets.KUBECONFIG_B64 }}
        run: |
          set -euo pipefail
          install -d -m 0700 "$HOME/.kube"
          echo "$KUBECONFIG_B64" | base64 -d > "$HOME/.kube/config"
          chmod 600 "$HOME/.kube/config"
          for i in $(seq 1 10); do
            if kubectl cluster-info >/dev/null 2>&1; then
              break
            fi
            sleep 3
          done
          kubectl cluster-info

      - name: Apply manifests and ensure registry secret
        env:
          GHCR_USERNAME: ${{ github.actor }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
        run: |
          set -euo pipefail
          KUBE_NAMESPACE=app
          kubectl apply --dry-run=client -k core
          kubectl apply --dry-run=server -k core
          kubectl apply -k core
          kubectl apply --dry-run=client -k infra
          kubectl apply --dry-run=server -k infra
          kubectl apply -k infra
          kubectl -n ${KUBE_NAMESPACE} create secret docker-registry ghcr-pull \
            --docker-server=ghcr.io \
            --docker-username="${GHCR_USERNAME}" \
            --docker-password="${GHCR_TOKEN}" \
            --dry-run=client -o yaml \
            | kubectl apply -f -
          kubectl apply --dry-run=client -k apps/clash-api
          kubectl apply --dry-run=server -k apps/clash-api
          kubectl apply -k apps/clash-api
          kubectl apply --dry-run=client -k apps/clash-web
          kubectl apply --dry-run=server -k apps/clash-web
          kubectl apply -k apps/clash-web
          kubectl apply --dry-run=client -k apps/auth-api
          kubectl apply --dry-run=server -k apps/auth-api
          kubectl apply -k apps/auth-api
          kubectl apply --dry-run=client -k apps/auth-web
          kubectl apply --dry-run=server -k apps/auth-web
          kubectl apply -k apps/auth-web

      - name: E2E check (k8s)
        run: |
          set -euo pipefail
          KUBE_NAMESPACE=app
          kubectl -n ${KUBE_NAMESPACE} rollout status deploy/clash-api --timeout=60s
          kubectl -n ${KUBE_NAMESPACE} rollout status deploy/clash-web --timeout=60s
          kubectl -n ${KUBE_NAMESPACE} rollout status deploy/auth-api --timeout=60s
          kubectl -n ${KUBE_NAMESPACE} rollout status deploy/auth-web --timeout=60s
